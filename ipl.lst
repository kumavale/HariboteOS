     1                                  ; haribote-ipl
     2                                  ; TAB=4
     3                                  
     4                                  CYLS EQU 10                     ; #define CYLS 10
     5                                  
     6                                          ORG     0x7c00          ; メモリ上の開始位置
     7 00000000 EB4E                            JMP     entry
     8 00000002 90                              DB      0x90
     9 00000003 48415249424F5445                DB      "HARIBOTE"      ; ブートセレクタの名前を自由にかいていよい  (8Byte)
    10 0000000B 0002                            DW      512             ; 1セクタの大きさ                           (512にしなければならない)
    11 0000000D 01                              DB      1               ; クラスタの大きさ                          (1セクタにしなければならない)
    12 0000000E 0100                            DW      1               ; FATがどこから始まるか                     (普通は1セクタ目からにする)
    13 00000010 02                              DB      2               ; FATの個数                                 (2にしなければならない)
    14 00000011 E000                            DW      224             ; ルートディレクトリ領域の大きさ            (普通は224エントリにする)
    15 00000013 400B                            DW      2880            ; このドライブの大きさ                      (2880セクタにしなければならない)
    16 00000015 F0                              DB      0xf0            ; メディアタイプ                            (0xf0にしなければならない)
    17 00000016 0900                            DW      9               ; FAT領域の長さ                             (9セクタにしなければならない)
    18 00000018 1200                            DW      18              ; 1トラックにいくつのセクタがあるか         (18にしなければならない)
    19 0000001A 0200                            DW      2               ; ヘッドの数                                (2にしなければならない)
    20 0000001C 00000000                        DD      0               ; パーティションを使っていないのでここは必ず0
    21 00000020 400B0000                        DD      2880            ; このドライブの大きさをもう一度書く
    22 00000024 000029                          DB      0, 0, 0x29      ; よくわからないけどこの値にしておくといいらしい
    23 00000027 FFFFFFFF                        DD      0xffffffff      ; たぶんボリュームシリアル番号
    24 0000002B 48415249424F54454F-             DB      "HARIBOTEOS "   ; ディスクの名前                            (11Byte)
    24 00000034 5320               
    25 00000036 4641543132202020                DB      "FAT12   "      ; フォーマットの名前                        (8Byte)
    26 0000003E 00<rept>                        TIMES   18  DB 0        ; とりあえず18バイト開けておく
    27                                  
    28                                  ; Program Main Body
    29                                  entry:
    30 00000050 B80000                          MOV     AX, 0           ; レジスタの初期化
    31 00000053 8ED0                            MOV     SS, AX
    32 00000055 BC007C                          MOV     SP, 0x7c00
    33 00000058 8ED8                            MOV     DS, AX
    34                                  
    35                                  ; Read Disk
    36 0000005A B82008                  				MOV			AX, 0x0820
    37 0000005D 8EC0                    				MOV			ES, AX
    38 0000005F B500                    				MOV			CH, 0           ; シリンダ番号0
    39 00000061 B600                    				MOV			DH, 0						; ヘッド番号0
    40 00000063 B102                    				MOV			CL, 2						; セクタ番号2
    41                                  
    42                                  readloop:
    43 00000065 BE0000                  				MOV			SI, 0           ; 失敗回数のリセット
    44                                  
    45                                  retry:
    46 00000068 B402                    				MOV			AH, 0x02				; INT命令用
    47 0000006A B001                    				MOV			AL, 1
    48 0000006C BB0000                  				MOV			BX, 0
    49 0000006F B200                    				MOV			DL, 0x00				; ドライブ番号0 <--①
    50 00000071 CD13                    				INT			0x13    				; disk BIOSコール(AH=0x02) <--②-1
    51 00000073 7310                    				JNC			next						; エラーがなければnextへ
    52 00000075 83C601                  				ADD			SI, 1						; SIレジスタ(失敗回数) + 1
    53 00000078 83FE05                  				CMP			SI, 5						; SIと5を比較
    54 0000007B 732E                    				JAE			error						; SI >= 5のときerrorへ
    55 0000007D B400                    				MOV			AH, 0x00				; INT命令用
    56 0000007F B200                    				MOV			DL, 0x00				; ドライブ番号0
    57 00000081 CD13                    				INT			0x13						; disk BIOSコール(AH=0x00) <--②-2
    58 00000083 EBE3                    				JMP			retry
    59                                  
    60                                  
    61                                  next:
    62 00000085 8CC0                    				MOV			AX, ES					; アドレスを0x200(=512=1セクタ)進める
    63 00000087 83C020                  				ADD			AX, 0x20
    64 0000008A 8EC0                    				MOV			ES, AX					; ADD ES, 0x20という命令が無い
    65 0000008C 80C101                  				ADD			CL, 1						; CL(セクタ番号)を1増やす
    66 0000008F 80F912                  				CMP			CL, 18					; CLと18を比較
    67 00000092 76D1                    				JBE			readloop				; CL <= 18の時readloopへ
    68 00000094 B101                    				MOV			CL, 1						; CL=1
    69 00000096 80C601                  				ADD			DH, 1						; DH(ヘッダ番号)を1増やす
    70 00000099 80FE02                  				CMP			DH, 2						; DHと2を比較
    71 0000009C 72C7                    				JB			readloop				; DH < 2の時readloopへ
    72 0000009E B600                    				MOV			DH, 0						; DH=0
    73 000000A0 80C501                  				ADD			CH, 1						; CH(シリンダ番号)を1増やす
    74 000000A3 80FD0A                  				CMP			CH, CYLS				; CHとCYLS(=10)を比較
    75 000000A6 72BD                    				JB			readloop				; CH < CYLSの時readloopへ
    76                                  
    77                                  fin:
    78 000000A8 F4                      				HLT
    79 000000A9 EBFD                    				JMP			fin
    80                                  
    81                                  error:
    82 000000AB BE[C000]                				MOV			SI, msg					; SIにmsgのメモリ番地を代入
    83                                  
    84                                  putloop:
    85 000000AE 8A04                            MOV     AL, [SI]        ; BYTE (accumulator low)
    86 000000B0 83C601                          ADD     SI, 1           ; increment
    87 000000B3 3C00                            CMP     AL, 0           ; compare (<end msg>)
    88 000000B5 74F1                            JE      fin             ; jump to fin if equal to 0
    89 000000B7 B40E                            MOV     AH, 0x0e        ; AH = 0x0e
    90 000000B9 BB0F00                          MOV     BX, 15          ; BH = 0, BL = <color code>
    91 000000BC CD10                            INT     0x10            ; interrupt BIOS
    92 000000BE EBEE                            JMP     putloop
    93                                  
    94                                  msg:
    95 000000C0 0A0A                            DB      0x0a, 0x0a
    96 000000C2 6C6F6164206572726F-             DB      "load error"    ; Error message
    96 000000CB 72                 
    97 000000CC 0A                              DB      0x0a
    98 000000CD 00                              DB      0               ; end msg
    99                                  
   100 000000CE 00<rept>                        TIMES   0x7dfe-0x7c00-($-$$)  DB 0
   101                                  
   102                                  ; END BS_BootCode
   103 000001FE 55AA                            DB      0x55, 0xaa      ; BS_BootSign, boot signature
